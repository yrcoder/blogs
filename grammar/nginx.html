<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>nginx | YRcoder</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/blogs/assets/css/0.styles.49137356.css" as="style"><link rel="preload" href="/blogs/assets/js/app.2b612f2a.js" as="script"><link rel="preload" href="/blogs/assets/js/16.9a7002c8.js" as="script"><link rel="prefetch" href="/blogs/assets/js/19.32209c0d.js"><link rel="prefetch" href="/blogs/assets/js/2.d8d0300f.js"><link rel="prefetch" href="/blogs/assets/js/3.78bce9f9.js"><link rel="prefetch" href="/blogs/assets/js/4.a3a81660.js"><link rel="prefetch" href="/blogs/assets/js/5.43029159.js"><link rel="prefetch" href="/blogs/assets/js/6.875575e2.js"><link rel="prefetch" href="/blogs/assets/js/7.c9ffc06c.js"><link rel="prefetch" href="/blogs/assets/js/8.93c6ec89.js"><link rel="prefetch" href="/blogs/assets/js/9.84e0ec54.js"><link rel="prefetch" href="/blogs/assets/js/10.db99257f.js"><link rel="prefetch" href="/blogs/assets/js/11.687313e6.js"><link rel="prefetch" href="/blogs/assets/js/12.28f8784f.js"><link rel="prefetch" href="/blogs/assets/js/13.0b2e299e.js"><link rel="prefetch" href="/blogs/assets/js/14.ca8ee814.js"><link rel="prefetch" href="/blogs/assets/js/15.043efc1f.js"><link rel="prefetch" href="/blogs/assets/js/17.e74890e2.js"><link rel="prefetch" href="/blogs/assets/js/18.faaea426.js"><link rel="prefetch" href="/blogs/assets/js/20.fce76639.js"><link rel="prefetch" href="/blogs/assets/js/21.1ac604c1.js"><link rel="prefetch" href="/blogs/assets/js/22.5cc26646.js"><link rel="prefetch" href="/blogs/assets/js/23.26b6189b.js"><link rel="prefetch" href="/blogs/assets/js/24.243fe967.js"><link rel="prefetch" href="/blogs/assets/js/25.00d13d8e.js"><link rel="prefetch" href="/blogs/assets/js/26.9793daa6.js"><link rel="prefetch" href="/blogs/assets/js/27.5e040fb5.js"><link rel="prefetch" href="/blogs/assets/js/28.eac84346.js"><link rel="prefetch" href="/blogs/assets/js/29.ac1518e6.js"><link rel="prefetch" href="/blogs/assets/js/30.cb0249c5.js"><link rel="prefetch" href="/blogs/assets/js/31.1f406963.js"><link rel="prefetch" href="/blogs/assets/js/32.27c448e1.js"><link rel="prefetch" href="/blogs/assets/js/33.66d1b1d4.js"><link rel="prefetch" href="/blogs/assets/js/34.8f89af58.js"><link rel="prefetch" href="/blogs/assets/js/35.95d09688.js"><link rel="prefetch" href="/blogs/assets/js/36.0cdd6acb.js"><link rel="prefetch" href="/blogs/assets/js/37.f7075148.js"><link rel="prefetch" href="/blogs/assets/js/38.13ffb522.js"><link rel="prefetch" href="/blogs/assets/js/39.4edced61.js"><link rel="prefetch" href="/blogs/assets/js/40.5e43f35a.js">
    <link rel="stylesheet" href="/blogs/assets/css/0.styles.49137356.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blogs/" class="home-link router-link-active"><!----> <span class="site-name">YRcoder</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blogs/grammar/htmlCss.html" class="nav-link">语法</a></div><div class="nav-item"><a href="/blogs/ruminate/前端的总结.html" class="nav-link">反刍</a></div><div class="nav-item"><a href="/blogs/other/createNote.html" class="nav-link">other</a></div><div class="nav-item"><a href="/blogs/excerpt/excerpt.html" class="nav-link">摘抄</a></div> <a href="https://github.com/yrcoder" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blogs/grammar/htmlCss.html" class="nav-link">语法</a></div><div class="nav-item"><a href="/blogs/ruminate/前端的总结.html" class="nav-link">反刍</a></div><div class="nav-item"><a href="/blogs/other/createNote.html" class="nav-link">other</a></div><div class="nav-item"><a href="/blogs/excerpt/excerpt.html" class="nav-link">摘抄</a></div> <a href="https://github.com/yrcoder" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>一层语法</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blogs/grammar/htmlCss.html" class="sidebar-link">html</a></li><li><a href="/blogs/grammar/less.html" class="sidebar-link">less</a></li><li><a href="/blogs/grammar/js.html" class="sidebar-link">JavaScript</a></li><li><a href="/blogs/grammar/es6.html" class="sidebar-link">ES6</a></li><li><a href="/blogs/grammar/vue.html" class="sidebar-link">vue</a></li><li><a href="/blogs/grammar/react.html" class="sidebar-link">react</a></li><li><a href="/blogs/grammar/managingState.html" class="sidebar-link">mobx</a></li><li><a href="/blogs/grammar/router.html" class="sidebar-link">router</a></li><li><a href="/blogs/grammar/debug.html" class="sidebar-link">调试</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>二层语法</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blogs/grammar/webpack.html" class="sidebar-link">webpack</a></li><li><a href="/blogs/grammar/git.html" class="sidebar-link">git</a></li><li><a href="/blogs/grammar/vueSSR.html" class="sidebar-link">vueSSR</a></li><li><a href="/blogs/grammar/reactSSR.html" class="sidebar-link">ReactSSR</a></li><li><a href="/blogs/grammar/nginx.html" class="active sidebar-link">nginx</a></li><li><a href="/blogs/grammar/http.html" class="sidebar-link">http</a></li><li><a href="/blogs/grammar/node.html" class="sidebar-link">node</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>三层语法</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blogs/grammar/reactDesignPattern.html" class="sidebar-link">react 设计模式和最佳实战</a></li><li><a href="/blogs/grammar/jsDesignPattern.html" class="sidebar-link">javascript 设计模式</a></li><li><a href="/blogs/grammar/zepto源码.html" class="sidebar-link">zepto 设计和源码分析</a></li><li><a href="/blogs/grammar/vue源码.html" class="sidebar-link">vue 源码</a></li><li><a href="/blogs/grammar/react源码.html" class="sidebar-link">react 源码</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="nginx"><a href="#nginx" aria-hidden="true" class="header-anchor">#</a> nginx</h1> <p>云主机重装了一下系统后，再登录本机会有之前服务器的信息，将之删掉即可
错误信息中有：Add correct host key in /Users/dashu/.ssh/known_hosts to get rid of this message.
在/Users/dashu/.ssh/known_hosts 该文件下删除重装主机的信息，重新登录即可</p> <p>cd /etc/nginx/conf.d</p> <p>把公钥放到 ssh 文件下就不用输密码了</p> <div class="language-sh extra-class"><pre class="language-text"><code># 获取本机的公钥
cd ~
cd .ssh/
ls
# 公钥
cat id_rsa.pub

# 把公钥放在服务器上
cd ~
cd .ssh/
ll
vi authorized_keys
</code></pre></div><p>更改 nginx 配置
在 nginx 目录下创建一个文件夹，放前端打包后的代码
然后在 nginx/conf.d 目录下创建对应文件名的配置文件</p> <div class="language-sh extra-class"><pre class="language-text"><code>cd /etc/nginx/conf.d
cat tsxy.conf

server {
    listen  80;
    server_name tsxy.loan.test.shufanfinance.com;

       location /  {
            root  /usr/share/nginx/tsxy/;
            try_files $uri $uri/ @routerSso;
            index   index.html index.htm;
        }

        location @routerSso {
            rewrite ^.*$  / last;
        }


    location /gateway {
        proxy_pass  http://192.168.5.89:8190/;
        proxy_set_header  Host     $host;
        proxy_set_header  X-Real-IP  $remote_addr;
        proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;
        proxy_read_timeout 3600s;
        client_max_body_size    1000m;

    }
}

cp tsxy.conf workflow.conf
# 更改配置文件之后要重启nginx服务
# 然后上传文件就可以了
sshpass -p 'hengtian' ssh root@192.168.5.157 &quot;cd /usr/share/nginx/birpt/; rm -rf *&quot;
sshpass -p hengtian scp -r build/* root@192.168.5.157:/usr/share/nginx/birpt/.
</code></pre></div><p>shell 基本操作</p> <div class="language-sh extra-class"><pre class="language-text"><code># 登陆
ssh root@192.168.203.9
root：指用户名
192.168.203.9：服务器IP
# 打开文件
cd ~
cd ..
cd ../myFile
cd [foldername]
# 创建文件
mkdir [foldername]
# 删除文件夹
rm -rf [foldername]
# 查看
cat [filename]
# 查看文件所在目录
pwd
# 编辑
vi [filename]
vim [filename]
# 在文件中开始编辑(插入)
i
# 结束编辑状态
esc
# 强制保存退出
!wq
# 退出(!强制)
esc + 冒号 + q + !
# 拷贝 cp [srcname] [targetname]
cp tsxy.conf workflow.conf
# 列出文件
ls
ll
ll -li
# 登出
exit
# 重启
nginx -s reload
</code></pre></div><h1 id="基础"><a href="#基础" aria-hidden="true" class="header-anchor">#</a> 基础</h1> <h1 id="场景实战"><a href="#场景实战" aria-hidden="true" class="header-anchor">#</a> 场景实战</h1> <h1 id="深度"><a href="#深度" aria-hidden="true" class="header-anchor">#</a> 深度</h1> <h1 id="架构"><a href="#架构" aria-hidden="true" class="header-anchor">#</a> 架构</h1> <h1 id="新特性"><a href="#新特性" aria-hidden="true" class="header-anchor">#</a> 新特性</h1> <h1 id="node-项目上线"><a href="#node-项目上线" aria-hidden="true" class="header-anchor">#</a> node 项目上线</h1> <p>前期准备
域名：
服务器：带外网 IP 的一台电脑，把项目部署上去，启动，监听 80 端口，根据转发的机制，把这些代码转发到 nodejs 后台的服务中
域名备案</p> <p>配置服务器应用环境
安装配置数据库
项目远程部署发布与更新</p> <p>光标回到行首：ctrl + a
光标回到行尾：ctrl + e</p> <div class="language-sh extra-class"><pre class="language-text"><code># 登录
ssh root@外网地址

# 查看linux系统的盘
fdisk -l

# 清空面板
command + r

# 查看硬盘使用情况
df -h

# 退出
logout

# 如果安装了zsh就会有.zshrc这个配置文件，在这个文件中可以加上一些软链接的命令。执行source .zshrc，配置就会生效

alias ssh_root=&quot;ssh root@外网地址&quot;

# 创建权限更低的用户，root会误操作不可恢复
adduser lyr
# passwd 用户名，给用户设置密码
# 给用户赋权, 输入命令在sudo的情况下可以操作命令
gpasswd -a lyr sudo # 没有办法执行该命令
sudo visudo # 更改配置文件
# 在user那一项, 把root的权限同样复制一份给lyr
root ALL=(ALL:ALL) ALL
# 重启ssh功能
service ssh restart

# 通过ssh实现无密码的登录,在根目录下创建打开.ssh文件夹，里面有配置文件，如果没有该文件夹就mkdir .ssh, 重新创建
pwd
ll -a
cd .ssh
未完

# 修改服务器默认登录端口(重启生效： sudo service ssh restart)
sudo vi /etc/ssh/sshd_config
Prot 39999
UseDNS no
AllowUsers lyr
PermitRootLogin no # 不允许root登录

登录也要换
ssh -p 39999 lyr@XXX # 默认端口是22

# 配置iptables （防火墙） 和 Fail2Ban
未完

# 安装node环境
系统更新
sudo apt-get update
安装包文件
sudo apt-get install vim open ssl build-essential libssl-dev wget curl git
安装nvm, 用wget安装
wget 去github nvm 仓库找链接
安装node
nvm install v8.12.0
nvm use v6.9.5
nvm alias default v6.9.5 # 系统的默认node版本为6.9.5
node -v
npm --registry=https://registry.npm.taobao.org install -g npm # npm用淘宝镜像
npm --registry=https://registry.npm.taobao.org install -g cnpm # npm用淘宝镜像
# echo fs.inotify.max_user_watches=524288
npm i pm2 webpack -g

# 让服务稳定的运行 pm2
在终端中启动服务，该服务只限于该终端的生命周期，
pm2 list
pm2 run app.js
pm2 logs # 当前实时日志
pm2 代码的自动更新
</code></pre></div><p>linux 常用命令
在 Fedora 上用 yum 安装
在 Ubuntu 这类 Debian 体系的系统上，可以用 apt-get 安装</p> <div class="language-sh extra-class"><pre class="language-text"><code># 查看软件安装的所有路径(地址)
whereis node # node: /root/.nvm/versions/node/v12.7.0/bin/node
whereis git # git: /usr/bin/git /usr/share/man/man1/git.1.gz
whereis nginx # nginx: /usr/sbin/nginx /usr/lib64/nginx /etc/nginx /usr/share/nginx /usr/share/man/man3/nginx.3pm.gz /usr/share/man/man8/nginx.8.gz

# 已经安装的但是不包含在资源库中的rpm包
yum list # 列出资源库中所有可以安装或更新的rpm包
yum list installed #
yum list perl # 列出名为perl  的包
yum list perl* # 列出perl 开头的包
yum list updates # 列出资源库中所有可以更新的rpm包
yum info # 列出资源库中所有可以安装或更新的rpm包的信息
yum info perl # 列出perl 包信息
yum info perl* # 列出perl 开头的所有包的信息
yum info updates # 列出资源库中所有可以更新的rpm包的信息
yum info installed # 列出已经安装的所有的rpm包的信息
yum info extras # 列出已经安装的但是不包含在资源库中的rpm包的信息

# 在github官网上找下载的链接 https://github.com/nvm-sh/nvm/blob/master/README.md
wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash
source ~/.bashrc
# 可查看node所有版本
nvm ls-remote
# 安装最新稳定版的nodejs
nvm install stable
nvm use node
nvm run node --version
# 安装pm2
npm install -g pm2
# 安装git
yum install git-core
# 安装nginx
yum install nginx

# 查看公钥
# 看机器有没有配置过公钥
pwd # 查看当前位置
ls -a # 查看以点为前缀的文件
cd .ssh # 里面的id_rsa.pub 就是公钥，如果没有这些文件说明没有，就要生产私钥和公钥
ssh-keygen -t rsa -b 4096 -C &quot;liyueru.com.cn&quot; # liyueru.com.cn邮箱名字
cat id_rsa.pub

# 让node项目稳定跑起来
pm2 start app.js # node app.js

# nginx 开机自动重启
# nginx 代理80端口的请求，分发给别的地址
# nginx的配置文件命名，一般会起程 对应的域名+要分发的端口
cd /etc/nginx/conf.d
vi liyueru.com.cn_8080.conf # 创建文件
# 内容如下： 将域名liyueru.com.cn指向服务器本地的8080端口
upstream blog {
	server 127.0.0.1:8080;
}

server {
	listen 80;
	# server_name 111.231.145.233; # 服务器的IP地址，不要端口
	server_name liyueru.com.cn; # 错误：server_name http://xxx.com;正确：server_name xxx.com;

	location / {
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forward-For $proxy_add_x_forwarded_for;
		proxy_set_header Host $http_host;
		proxy_set_header X-Nginx-Proxy true;
		proxy_pass http://127.0.0.1:8080;
		proxy_redirect off;
	}
}
# 内容结束，检查是否正确
nginx -t # 检测配置文件有没有问题
nginx # 启动
nginx  -s  stop # 关闭
nginx -s reload # 重启
# 前端和后端整合的配置
server {
    listen  80;
    server_name liyueru.com.cn;

    location /  {
        root  /usr/share/nginx/liyueru.com.cn-8080/;
        try_files $uri $uri/ @routerSso;
        index   index.html index.htm;
    }

    location @routerSso {
        rewrite ^.*$  / last;
    }

    location /gateway {
        proxy_pass  http://192.168.5.89:8190/;
        proxy_set_header Host     $host;
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For  $proxy_add_x_forwarded_for;
        proxy_read_timeout 3600s;
        client_max_body_size    1000m;
    }
}

# 服务器重启之后 重启nginx; nginx: [error] open() &quot;/run/nginx.pid&quot; failed (2: No such file or directory)
因为强制终止nginx之后，不能直接用重启命令，先执行nginx命令之后才

# 安装mysql https://www.cnblogs.com/shalldou/p/10767043.html   https://www.jianshu.com/p/455b93c451fd
# 查看mysql可允许登录的用户名和主机
select user,host from user;
# 删除mysql用户和主机（将上面的查询的到的用户名和主机写入即可）
DROP USER 'username'@'host';
# 添加用户和主机权限(host为%代表所有的都可以)
grant all on *.* to 'username'@'host' identified by 'password' with grant option;
grant all on *.* to 'root'@'%' identified by '123456' with grant option;
# 重新加载权限
flush privileges
</code></pre></div></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blogs/grammar/reactSSR.html" class="prev">
          ReactSSR
        </a></span> <span class="next"><a href="/blogs/grammar/http.html">
          http
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/blogs/assets/js/16.9a7002c8.js" defer></script><script src="/blogs/assets/js/app.2b612f2a.js" defer></script>
  </body>
</html>
