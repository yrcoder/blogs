(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{179:function(t,s,n){"use strict";n.r(s);var a=n(0),o=Object(a.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"content"},[n("h1",{attrs:{id:"pm2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#pm2","aria-hidden":"true"}},[t._v("#")]),t._v(" pm2")]),t._v(" "),n("p",[t._v("进程守护，\n多进程，\n记录日志")]),t._v(" "),n("h2",{attrs:{id:"命令"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#命令","aria-hidden":"true"}},[t._v("#")]),t._v(" 命令")]),t._v(" "),n("p",[t._v("pm2 start ...\npm2 list\npm2 restart [appName || id]\npm2 stop [appName || id]\npm2 delete [appName || id]\npm2 info [appName || id]\npm2 log [appName || id]\npm2 monit [appname || id]")]),t._v(" "),n("p",[t._v("进程守护，遇到错误自动重启")]),t._v(" "),n("h2",{attrs:{id:"配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置","aria-hidden":"true"}},[t._v("#")]),t._v(" 配置")]),t._v(" "),n("p",[t._v("新建 PM2 配置文件，包括进程数量，日志文件目录等(pm2.config.json)\n修改 PM2 启动命令，重启\n访问 server,检查日志文件等内容（日志记录是否生效）")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tapps"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        name"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'blog'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        script"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'app.js'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// bin/www")]),t._v("\n        cwd"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'./'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// 当前工作路径")]),t._v("\n        watch"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("true")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// 代码更改的时候自动重启服务")]),t._v("\n        "),n("span",{attrs:{class:"token comment"}},[t._v("// watch: [")]),t._v("\n        "),n("span",{attrs:{class:"token comment"}},[t._v("//     // 监控变化的目录，一旦变化，自动重启")]),t._v("\n        "),n("span",{attrs:{class:"token comment"}},[t._v("//     'src',")]),t._v("\n        "),n("span",{attrs:{class:"token comment"}},[t._v("//     'build',")]),t._v("\n        "),n("span",{attrs:{class:"token comment"}},[t._v("// ],")]),t._v("\n        ignore_watch"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n            "),n("span",{attrs:{class:"token string"}},[t._v('"node_modules"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),n("span",{attrs:{class:"token string"}},[t._v('"logs"')]),t._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        node_args"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'--harmony'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// node的启动模式")]),t._v("\n        instances"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("4")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v('// 多线程配置，逻辑核数, 值可以是max,"instances": (number|max)')]),t._v("\n        error_file"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'logs/err.log'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// 错误日志路径")]),t._v("\n        out_file"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'logs/out.log'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("//  普通日志路径")]),t._v("\n        merge_logs"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("true")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("//集群情况下，可以合并日志")]),t._v("\n        log_type"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'json'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        log_date_format"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'YYYY-MM-DD HH:mm:ss'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// 日志")]),t._v("\n        env"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),n("span",{attrs:{class:"token constant"}},[t._v("COMMON_VARIABLE")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token boolean"}},[t._v("true")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),n("span",{attrs:{class:"token constant"}},[t._v("PM2_SERVE_PATH")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"."')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("    "),n("span",{attrs:{class:"token comment"}},[t._v("//静态服务路径")]),t._v("\n            "),n("span",{attrs:{class:"token constant"}},[t._v("PM2_SERVE_PORT")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("8080")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("   "),n("span",{attrs:{class:"token comment"}},[t._v("//静态服务器访问端口")]),t._v("\n            "),n("span",{attrs:{class:"token constant"}},[t._v("NODE_ENV")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'development'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("//启动默认模式,设置运行环境，此时process.env.NODE_ENV的值就是development")]),t._v("\n            "),n("span",{attrs:{class:"token constant"}},[t._v("ORIGIN_ADDR")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'http://www.yoduao.com'")]),t._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        env_production "),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),n("span",{attrs:{class:"token constant"}},[t._v("NODE_ENV")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'production'")]),t._v("  "),n("span",{attrs:{class:"token comment"}},[t._v("//使用production模式 pm2 start ecosystem.config.js --env production")]),t._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    deploy "),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        production "),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            user "),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'node'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("                      "),n("span",{attrs:{class:"token comment"}},[t._v("// ssh 用户")]),t._v("\n            host "),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token string"}},[t._v("'212.83.163.1'")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("            "),n("span",{attrs:{class:"token comment"}},[t._v("// ssh 地址")]),t._v("\n            post"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("8000")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            ref  "),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'origin/master'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("             "),n("span",{attrs:{class:"token comment"}},[t._v("// GIT远程/分支")]),t._v("\n            repo "),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'git@github.com:repo.git'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("   "),n("span",{attrs:{class:"token comment"}},[t._v("// 项目 git地址,")]),t._v("\n            path "),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'/var/www/production'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("       "),n("span",{attrs:{class:"token comment"}},[t._v("// 服务器文件路径")]),t._v("\n            ssh_options"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'StrictHostKeyChecking=no'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// ssh校验关闭")]),t._v("\n            env"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),n("span",{attrs:{class:"token constant"}},[t._v("NODE_ENV")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'production'")]),t._v("\n            "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),n("span",{attrs:{class:"token string"}},[t._v('"post-deploy"')]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'npm install && pm2 reload ecosystem.config.js --env production'")]),t._v("  "),n("span",{attrs:{class:"token comment"}},[t._v("//部署后的动作")]),t._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h2",{attrs:{id:"多进程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#多进程","aria-hidden":"true"}},[t._v("#")]),t._v(" 多进程")]),t._v(" "),n("p",[t._v("多进程之间无法共享内存\n多进程访问一个 redis，实现数据共享")]),t._v(" "),n("h1",{attrs:{id:"git-和自动部署"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#git-和自动部署","aria-hidden":"true"}},[t._v("#")]),t._v(" git 和自动部署")])])}],!1,null,null,null);o.options.__file="pm2.md";s.default=o.exports}}]);